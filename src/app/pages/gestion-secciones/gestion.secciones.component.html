<div class="admin-panel-container">
  <h2>Registro de Sección</h2>
  <p>Define una nueva sección para un curso, asignando un docente y capacidad.</p>

  <form [formGroup]="seccionForm" (ngSubmit)="onSubmit()" class="admin-form">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="curso">Nombre del Curso</label>
          <select 
            id="curso" 
            formControlName="curso" 
            class="form-select"
            [class.is-invalid]="seccionForm.get('curso')?.invalid && seccionForm.get('curso')?.touched">
            <option value="">[Seleccionar Curso]</option>
            @for (curso of listaCursos; track curso.id) {
              <option [value]="curso.nombre">{{ curso.nombre }}</option>
            }
          </select>
          @if (seccionForm.get('curso')?.invalid && seccionForm.get('curso')?.touched) {
            <div class="text-danger small mt-1">Seleccione un curso.</div>
          }
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label for="docente">Docente</label>
          <select 
            id="docente" 
            formControlName="docente" 
            class="form-select"
            [class.is-invalid]="seccionForm.get('docente')?.invalid && seccionForm.get('docente')?.touched">
            <option value="">[Seleccionar Docente]</option>
            @for (doc of listaDocentes; track doc.id) {
              <option [value]="doc.nombres + ' ' + doc.apellidos">{{ doc.nombres }} {{ doc.apellidos }}</option>
            }
          </select>
          @if (seccionForm.get('docente')?.invalid && seccionForm.get('docente')?.touched) {
            <div class="text-danger small mt-1">Seleccione un docente.</div>
          }
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="aula">Aula</label>
          <input 
            type="text" 
            id="aula" 
            formControlName="aula" 
            class="form-control" 
            placeholder="Ej: A-101"
            [class.is-invalid]="seccionForm.get('aula')?.invalid && seccionForm.get('aula')?.touched">
        
          @if (seccionForm.get('aula')?.invalid && seccionForm.get('aula')?.touched) {
            <div class="text-danger small mt-1">
              <i class="fa-solid fa-circle-exclamation me-1"></i>
              El código de aula es obligatorio
            </div>
          }

          </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label for="capacidad">Capacidad</label>
          <input 
            type="number" 
            id="capacidad" 
            formControlName="capacidad" 
            class="form-control"
            [class.is-invalid]="seccionForm.get('capacidad')?.invalid && seccionForm.get('capacidad')?.touched">

            @if (seccionForm.get('capacidad')?.hasError('required') && seccionForm.get('capacidad')?.touched) {
            <div class="text-danger small mt-1">La capacidad es obligatoria.</div>
            }
            @if (seccionForm.get('capacidad')?.hasError('min') && seccionForm.get('capacidad')?.touched) {
              <div class="text-danger small mt-1">La capacidad debe ser al menos 1.</div>
            }
        </div>
      </div>
    </div>

    @if (formSuccessMessage) { <div class="server-success-msg">{{ formSuccessMessage }}</div> }
    @if (formErrorMessage) { <div class="server-error-msg">{{ formErrorMessage }}</div> }

    <div class="d-flex">
      <button type="submit" [disabled]="seccionForm.invalid" class="btn-save btn-small">
        <i class="fa-solid fa-plus me-1"></i> Crear Sección
      </button>
    </div>
  </form>
</div>

<div class="admin-panel-container all-users-panel">
  <h2>Secciones Registradas</h2>

  <div class="search-container mb-4 p-3 bg-white rounded shadow-sm border">
    <div class="row g-3 align-items-end">
      
      <!-- Filtro por Curso (Izquierda) -->
      <div class="col-md-5">
        <label class="form-label small text-muted">Filtrar por Curso</label>
        <div class="input-group">
          <span class="input-group-text bg-light"><i class="fa-solid fa-book"></i></span>
          <select class="form-select" 
                  [(ngModel)]="filtroCursoSeleccionado" 
                  (change)="onFiltroCursoChange()">
            <option value="">-- Todos los cursos --</option>
            <option *ngFor="let curso of cursosFiltro" [value]="curso">
              {{ curso }}
            </option>
          </select>
        </div>
      </div>
      
      <!-- Filtro por Sección (Derecha - Dependiente) -->
      <div class="col-md-5">
        <label class="form-label small text-muted">Filtrar por Sección</label>
        <div class="input-group">
          <span class="input-group-text bg-light"><i class="fa-solid fa-barcode"></i></span>
          <select class="form-select" 
                  [(ngModel)]="filtroSeccionSeleccionada" 
                  (change)="onBuscar()"
                  [disabled]="!filtroCursoSeleccionado">
            <option value="">-- Todas las secciones --</option>
            <option *ngFor="let codigo of seccionesFiltro" [value]="codigo">
              {{ codigo }}
            </option>
          </select>
        </div>
      </div>

      <!-- Botones -->
      <div class="col-md-2 d-flex">
        <button class="btn btn-outline-secondary w-100" (click)="limpiarFiltros()" title="Limpiar Filtros">
          <i class="fa-solid fa-rotate-left me-1"></i> Limpiar
        </button>
      </div>
    </div>
  </div>

  @if (tableErrorMessage) { <div class="server-error-msg">{{ tableErrorMessage }}</div> }

  @if (listaSecciones.length === 0) {
    <p class="empty-msg">No hay secciones registradas.</p>
  } @else {
    <div class="table-responsive">
      <table class="panel-table">
        <thead>
          <tr>
            <th>Código</th>
            <th>Curso</th>
            <th>Docente</th>
            <th>Aula</th>
            <th>Capacidad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (seccion of seccionesPaginadas; track seccion.id) {
            <tr>
              <td>{{ seccion.codigoSeccion }}</td> 
              <td>{{ seccion.curso }}</td>
              <td>{{ seccion.docente }}</td>
              <td>{{ seccion.aula }}</td>
              <td>{{ seccion.capacidad }}</td>
              <td>
                <button (click)="onVerEstudiantes(seccion)" class="btn-icon btn-icon-view" title="Ver Estudiantes">
                  <i class="fa-solid fa-users"></i>
                </button>
                <button (click)="onEditar(seccion)" class="btn-icon btn-icon-edit" title="Editar">
                  <i class="fa-solid fa-pencil-alt"></i>
                </button>
                <button (click)="onEliminar(seccion.id)" class="btn-icon btn-icon-delete" title="Eliminar">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <app-pagination
        [totalPaginas]="totalPaginas"
        [paginaActual]="paginaActual"
        (irAPagina)="aplicarPaginacion($event)">
    </app-pagination>
  }
</div>

<!-- MODAL DE LISTADO DE ESTUDIANTES -->
@if (mostrarModalEstudiantes && seccionSeleccionadaParaVer) {
  <div class="modal-backdrop">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Estudiantes - {{ seccionSeleccionadaParaVer.codigoSeccion }}</h3>
        <button (click)="cerrarModalEstudiantes()" class="btn-close">&times;</button>
      </div>
      
      <div class="modal-body">
        <p class="text-muted mb-3">
          Curso: <strong>{{ seccionSeleccionadaParaVer.curso }}</strong> | 
          Docente: <strong>{{ seccionSeleccionadaParaVer.docente }}</strong>
        </p>

        @if (loadingEstudiantes) {
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Cargando lista de estudiantes...</p>
          </div>
        } @else if (listaEstudiantesSeccion.length === 0) {
          <div class="alert alert-info text-center">
            <i class="fa-solid fa-info-circle me-2"></i>
            No hay estudiantes inscritos en esta sección.
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table table-hover table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Código</th>
                  <th>Apellidos y Nombres</th>
                  <th>Fecha Matrícula</th>
                </tr>
              </thead>
              <tbody>
                @for (est of listaEstudiantesSeccion; track est.id) {
                  <tr>
                    <td>{{ est.codigoEstudiante }}</td>
                    <td>{{ est.nombreCompleto }}</td>
                    <td>{{ est.fechaMatricula | date:'dd/MM/yyyy' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          <div class="text-end mt-2">
            <small class="text-muted">Total inscritos: {{ listaEstudiantesSeccion.length }}</small>
          </div>
        }
      </div>

      <div class="modal-footer">
        <button type="button" (click)="cerrarModalEstudiantes()" class="btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>
}


@if (mostrarModalEdicion && seccionEnEdicion) {
  <div class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Sección</h3>
        <button (click)="cerrarModalEdicion()" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="seccionEditForm" (ngSubmit)="onSubmitEdicion()">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="cursoEdit">Nombre del Curso</label>
                <select id="cursoEdit" formControlName="curso" class="form-select">
                    <option value="">[Seleccionar Curso]</option>
                    @for (curso of listaCursos; track curso.id) {
                      <option [value]="curso.nombre">{{ curso.nombre }}</option>
                    }
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="docenteEdit">Docente</label>
                <select 
                  id="docenteEdit" 
                  formControlName="docente" 
                  class="form-select">
                  <option value="">[Seleccionar Docente]</option> 
                  
                  @for (doc of listaDocentes; track doc.id) {
                    <option [value]="doc.nombres + ' ' + doc.apellidos">{{ doc.nombres }} {{ doc.apellidos }}</option>
                  }
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="aulaEdit">Aula</label>
                <input type="text" id="aulaEdit" formControlName="aula" class="form-control">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="capacidadEdit">Capacidad</label>
                <input type="number" id="capacidadEdit" formControlName="capacidad" class="form-control">
              </div>
            </div>
          </div>

          @if (editFormSuccessMessage) { <div class="server-success-msg">{{ editFormSuccessMessage }}</div> }
          @if (editFormErrorMessage) { <div class="server-error-msg">{{ editFormErrorMessage }}</div> }

          <div class="modal-footer">
            <button type="button" (click)="cerrarModalEdicion()" class="btn-secondary">Cancelar</button>
            <button type="submit" [disabled]="seccionEditForm.invalid" class="btn-save">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>
}